---
layout: navigationBar.njk
CSSNesting: ../../CSS/
pageName: blog
pageNesting: ../../
---
    <div id="main">
        <div id="category-links">
            <h1>Categories</h1>
            <ul>
                {%- for category in collections.categories -%}
                    <li>
                        <a href="{{ page.pageNesting }}/interests/blog/categories/{{ category | slugify }}/index.html">{{ category }}</a>
                    </li>
                {%- endfor -%}
            </ul>
        </div>
        <div id="text-box">
            <h1>Blog Posts</h1>
            <ul>
                {%- for post in collections.post | reverse -%}
                    <h2>{{ post.data.title }}</h2>
                    <h3>{{ post.date | readableDateTime }}</h3>
                    <p>
                        {% excerpt post %}
                    </p>
                    </br>
                    <section id="comments">
                    <h2>Comments</h2>
                    <div id="comment-list"></div>
                    <form id="comment-form">
                        <input name="author" placeholder="Name" required />
                        <textarea name="text" required></textarea>
                        <button type="submit">Post</button>
                    </form>
                    </section>
                    <script>
                        // TODO Change for production
                        const API_BASE = "http://127.0.0.1:5000";
                        // const API_BASE = Raspberry Pi IP address/comments
                        const postId = window.location.pathname;

                        fetch(`${API_BASE}/comments?post=${postId}`)
                        .then(r => r.json())
                        .then(comments => {
                            document.getElementById("comment-list").innerHTML =
                            comments.map(c => `<p><b>${c.author}</b>: ${c.text}</p>`).join("");
                        });

                        document.getElementById("comment-form").addEventListener("submit", async e => {
                        e.preventDefault();
                        const form = e.target;

                        await fetch(`${API_BASE}/comments`, {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({
                            post: postId,
                            author: form.author.value,
                            text: form.text.value
                            })
                        });
                        location.reload();
                        });
                    </script>
                {%- endfor -%}
            </ul>
        </div>
    </div>